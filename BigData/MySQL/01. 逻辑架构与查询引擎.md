# MySQL逻辑架构与查询引擎

## 一、逻辑架构

### 1.1 连接层

* 目的：完成一些类似于连接处理、授权认证、及相关的安全方案
* 内容：客户端和连接服务
* 核心技术：线程池，基于SSL的安全链接

### 1.2 服务层

* Management Services & Utilities
* SQL Interface：接受用户的SQL命令，并且返回用户需要查询的结果
* Parser（解析器）：SQL命令传递到解析器的时候会被解析器验证和解析
* Optimizer（查询优化器）“SQL语句在查询之前会使用查询优化器对查询进行优化
* Cache与Buffer：如果查询缓存有命中的查询结果，查询语句就可以直接去查询缓存中取数据。这个缓存机制是由一系列小缓存组成的。比如表缓存，记录缓存，key缓存，权限缓存等

### 1.3 引擎层

* 存储引擎层，存储引擎真正的负责了MySQL中数据的存储和提取，服务器通过API与存储引擎进行通信

### 1.4 存储层

* 数据存储层，主要是将数据存储在运行于裸设备的文件系统之上，并完成与存储引擎的交互

### 1.5 MySQL的查询流程

1. mysql客户端通过协议与mysql服务器建立连接，发送查询语句，检查查询缓存，命中则返回结果，此操作提高了系统的性能
2. 若未命中，通过关键字将SQL语句进行解析，生成对应的解析树，mysql解析器使用mysql语法规则验证和解析查询，预处理器则根据一些mysql规则进一步检查解析数是否合法
3. 当解析树被认为是合法的了，优化器将其转化成执行计划（选取最优的执行计划）

## 二、存储引擎

### 2.1 InnoDB

* InnoDB是MySQL的`默认事务型引擎`，它被设计用来处理大量的短期(short-lived)事务

### 2.2 MyISAM

* MyISAM提供了大量的特性，包括全文索引、压缩、空间函数(GIS)等，但MyISAM`不支持事务和行级锁`，有一个毫无疑问的缺陷就是崩溃后无法安全恢复

### 2.3 Archive

* Archive档案存储引擎`只支持INSERT和SELECT操作`，在MySQL5.1之前不支持索引
* 适合日志和数据采集类应用

### 2.4 Blackhole

* Blackhole引擎没有实现任何存储机制，它会`丢弃所有插入的数据，不做任何保存`
* 但服务器会记录Blackhole表的日志，所以可以用于复制数据到备库，或者简单地记录到日志

### 2.5 CSV

* 可以将普通的CSV文件作为MySQL的表来处理，但`不支持索引`

### 2.6 Memory

* 如果需要快速地访问数据，并且这些`数据不会被修改，重启以后丢失也没有关系`，那么使用Memory表是非常有用
* Memory表至少比MyISAM表要快一个数量级

### 2.7 Federated

* Federated引擎是访问其他MySQL服务器的一个代理，尽管该引擎看起来提供了一种很好的跨服务器的灵活性，但也经常带来问题，因此默认是禁用的

### 2.8 MyISAM 和 InnoDB 对比

| 对比项 | MyISAM | InnoDB |
| :--- | :--- | :--- |
| 外键 | 不支持 | 支持 |
| 事务 | 不支持 | 支持 |
| 行表锁 | 表锁：只修改一行也会锁住整张表，不适合高并发 | 行锁：操作时只锁住一行，对其他没影响，适合高并发 |
| 缓存 | 只缓存索引，不缓存真实数据 | 索引和数据都会缓存，对内存要求高，且内存大小直接影响性能 |

### 2.9 查看引擎

```sql
-- 查看有哪些引擎
show engines;
-- 查看默认使用的引擎
show variables like '%storage_engine%';
```
