创建时间：v1.0 2021-09-24



一、概述

计算过程总体分为四大步骤：

\1) 标签规则自动获取与元数据同步；

\2) 根据取到的标签规则这查询SQL；

\3) 自动执行上步组装的查询SQL计算标签数据；

\4) 整理标签数据并导出到mysql或es供后台查询。

计算过程涉及到的数据库有mysql、hive、es，计算程序由hive SQL、spark完成，任务提交到Hadoop集群执行，数仓底层存储使用OSS，任务调度使用阿里云dataworks进行配置。

------

------



二、执行流程

2.1 标签规则自动获取与元数据同步

2.1.1 在dataworks中配置数据离线同步任务，每天凌晨同步后台数据库中的标签规则管理表：label、label_value、label_rule。

同步规则：每日同步一次全量数据，存入当天分区

| 后台库表名  | 数仓表名                      | 备注                       |
| ----------- | ----------------------------- | -------------------------- |
| label       | ods_label_factory_label       | 记录标签及其层级关系       |
| label_value | ods_label_factory_label_rule  | 记录每个标签的具体取值     |
| label_rule  | ods_label_factory_label_value | 记录每个标签取值的计算规则 |



2.1.2 数仓侧创建元数据表，管理用于标签计算的事实表、维度表的元数据，并在每天凌晨同步到后台数据库，保持两端使用同一套元数据。

| 数仓表名                | 后台库表名              | 备注                                   |
| ----------------------- | ----------------------- | -------------------------------------- |
| dic_tbl_meta_table_info | dic_tbl_meta_table_info | 记录库名、表名、表类型、表间的关联语句 |
| dic_tbl_meta_col_info   | dic_tbl_meta_col_info   | 记录字段名、所属表、字段类型           |

------



2.2 根据取到的标签规则这查询SQL

2.2.1 计算规则整合

使用Hive SQL关联ods_label_factory_label、ods_label_factory_label_rule、ods_label_factory_label_value三张表的数据，将每个标签取值的计算规则处理为一条数据，内容包括ID、标签名、标签值、计算规则等，计算结果存入表dwd_label_auto_label_rule

每天一个分区，存储全量的标签计算SQL

例如：

| 标签ID（label_id） | 标签名（label_name） | 标签值ID（label_value_id） | 标签值（label_value_name） | 计算规则组合关系（splice_type） | 需要查询的表ID（table_ids） | 计算规则（rule）                                             |
| ------------------ | -------------------- | -------------------------- | -------------------------- | ------------------------------- | --------------------------- | ------------------------------------------------------------ |
| 4273872330760      | 性别                 | 2094768211611648           | 男                         | and                             | ["100002"]                  | [{"tbl_id":"100002","field_id":"1000020004","rule_id":"1","value":"男"}] |

计算规则使用JSON数组存储：

| 字段名   | 含义                                    |
| -------- | --------------------------------------- |
| tbl_id   | 查询字段所属的表ID                      |
| field_id | 此条规则需要查询的字段ID                |
| rule_id  | SQL运算符ID，具体运算符需与码表关联获取 |
| value    | 此条规则查询字段的对比值                |



2.2.2 根据计算规则组装查询SQL

编写Spark程序读取上步的规则数据组装查询SQL（com.fosun.cdp.label.app.LabelRuleApp），计算结果存入表dwd_label_auto_label_query

SQL的组装分为四个部分：select部分、from部分、where部分、group部分，组装结果如下：

select d1.guid , '4273872330760' as label_id , '性别' as label_name , '2094768211611648' as label_value_id , '男' as label_value_name , null as label_weight from cdm.dim_pub_member_info d1 where cast(d1.gender as string) = '男' group by d1.guid

2.2.2.1 select部分

此处获取的字段固定为：会员OneID（guid）、标签ID（label_id）、标签名（label_name）、标签值ID（label_value_id）、标签值（label_value_name）、标签权重（label_weight）

![产业运营中台 > 标签自动计算逻辑v1.0 > image2021-9-24_16-5-2.png](D:/Projects/Git/Big_Data_Technology_WH/Notes/BigData/CDP/%E6%A0%87%E7%AD%BE%E8%87%AA%E5%8A%A8%E8%AE%A1%E7%AE%97v1.0.assets/image2021-9-24_16-5-2.png)

2.2.2.2 from部分

根据查询表数量的不同，会分布不同情况处理：

![产业运营中台 > 标签自动计算逻辑v1.0 > image2021-9-24_16-41-59.png](D:/Projects/Git/Big_Data_Technology_WH/Notes/BigData/CDP/%E6%A0%87%E7%AD%BE%E8%87%AA%E5%8A%A8%E8%AE%A1%E7%AE%97v1.0.assets/image2021-9-24_16-41-59.png)

2.2.2.3 where部分

循环规则字段的JSON数组拼接筛选条件

![产业运营中台 > 标签自动计算逻辑v1.0 > image2021-9-24_16-56-16.png](D:/Projects/Git/Big_Data_Technology_WH/Notes/BigData/CDP/%E6%A0%87%E7%AD%BE%E8%87%AA%E5%8A%A8%E8%AE%A1%E7%AE%97v1.0.assets/image2021-9-24_16-56-16.png)

2.2.2.4 group部分

![产业运营中台 > 标签自动计算逻辑v1.0 > image2021-9-24_16-43-41.png](D:/Projects/Git/Big_Data_Technology_WH/Notes/BigData/CDP/%E6%A0%87%E7%AD%BE%E8%87%AA%E5%8A%A8%E8%AE%A1%E7%AE%97v1.0.assets/image2021-9-24_16-43-41.png)

2.2.2.5 将以上四个部分拼接为完整的查询SQL，同标签ID等字段一期存入表dwd_label_auto_label_query

| label_id      | label_name | label_value_id   | label_value_name | query_sql                                                    |
| ------------- | ---------- | ---------------- | ---------------- | ------------------------------------------------------------ |
| 4273872330760 | 性别       | 2094768211611648 | 男               | select d1.guid , '4273872330760' as label_id , '性别' as label_name , '2094768211611648' as label_value_id , '男' as label_value_name , null as label_weight from cdm.dim_pub_member_info d1 where cast(d1.gender as string) = '男' group by d1.guid |



------

2.3 计算标签数据

编写Spark程序读取上一步生成的query_sql，并执行计算，计算结果存入表dws_label_auto_label_calculate

每天一个分区，存储全量计算结果

| guid                 | label_id      | label_name | label_value_id   | label_value_name | label_value_weight |
| -------------------- | ------------- | ---------- | ---------------- | ---------------- | ------------------ |
| 10016954475984562204 | 4273872330760 | 性别       | 2127243464912896 | 女               |                    |



------

2.4 整理标签数据并导出

每天一个分区，存储全量计算结果

2.4.1 使用Hive SQL处理dws_label_auto_label_calculate数据，将每个会员的标签数据组装成JSON数组，结果存入表ads_auto_label_info

| guid                 | auto_label_array                                             |
| -------------------- | ------------------------------------------------------------ |
| 10000002905162712355 | [{"label_id":"4273872330754","label_name":"年龄","label_value":[{"label_value_id":"69288919039","label_value_name":"未知","label_value_weight":null}]},{"label_id":"4273872330760","label_name":"性别","label_value":[{"label_value_id":"2094968665788416","label_value_name":"未知","label_value_weight":null}]}] |

JSON数组的每个元素结构如下：

{   "label_id": "4273872330754",   "label_name": "年龄",   "label_value": [     {     "label_value_id": "69288919039",     "label_value_name": "未知",     "label_value_weight": null     }   ] }



| 字段名             | 含义                                 |
| ------------------ | ------------------------------------ |
| label_id           | 标签ID                               |
| label_name         | 标签名                               |
| label_value        | 标签值：JSON数组，由下面三个字段组成 |
| label_value_id     | 标签值ID                             |
| label_value_name   | 标签值                               |
| label_value_weight | 标签权重                             |



2.4.2 使用Hive SQL关联表ads_auto_label_info和会员维度表，获取会员的来源、来源ID等信息，其中部分属性为加密数据，结果存入表ads_menber_attribute_label_info

| 字段名      | 样例值                                                       |
| ----------- | ------------------------------------------------------------ |
| guid        | 10000087603686185266                                         |
| name        | 2b29e4613d14a2389cf64ea7555218b871943b2d0d48ec630da1484292a55d5d |
| gender      | 男                                                           |
| phone       | ["9068ef27ae440407f4377ec3166f3c63029d64cfd3228ec30499c38260694349"] |
| birthday    | fa07070f67ede327b7566af59a63770896b87b526e90246d8baadd7cfdaa09ed |
| province    | 北京                                                         |
| city        | 北京市                                                       |
| region      | 东城区                                                       |
| address     |                                                              |
| label_array | [{"label_id":"4273872330754","label_name":"年龄","label_value":[{"label_value_id":"69288919039","label_value_name":"未知","label_value_weight":null}]},{"label_id":"4273872330760","label_name":"性别","label_value":[{"label_value_id":"2094768211611648","label_value_name":"男","label_value_weight":null}]}] |
| src_ids     | [{"src":"laomiao","src_col":"uid","src_id":"6663326"},{"src":"laomiao","src_col":"industrymemberid","src_id":"1343090"},{"src":"laomiao","src_col":"phone","src_id":"9068ef27ae440407f4377ec3166f3c63029d64cfd3228ec30499c38260694349"}] |

其中 phone 字段为字符串数组；

label_array 字段为标签数据，格式与表 ads_auto_label_info 字段 auto_label_array 相同；

src_ids 字段为会员的来源ID，存储为JSON数组，每个元素结构如下：

{   "src": "laomiao",   "src_col": "uid",   "src_id": "6663326" }



| 字段名  | 含义                 |
| ------- | -------------------- |
| src     | 会员来源             |
| src_col | 来源系统的对应字段名 |
| src_id  | 来源系统的具体ID值   |



2.4.3 在dataworks配置离线同步任务，将表ads_menber_attribute_label_info数据同步到后台数据库

同步规则：每天将hive表当天的全量数据更新到目标表，mysql中只存储最新数据

后续考虑每天都将全数据存入ES中

| 数仓表名                        | 后台库表名 | 备注             |
| ------------------------------- | ---------- | ---------------- |
| ads_menber_attribute_label_info | label_info | 数据每日冷晨更新 |